# 优化单元测试和组件测试计划

## 1. 修复测试配置问题

### 1.1 修复 Jest 配置中 ts-jest 已弃用的配置方式
- 将 `globals.ts-jest` 配置迁移到 `transform` 选项中
- 确保 TypeScript 编译选项支持 `import.meta.env`

### 1.2 解决 import.meta.env 在 Jest 中的使用问题
- 在 aiService.ts 中添加环境变量访问的兼容处理
- 或者在测试环境中模拟 import.meta.env

## 2. 修复测试代码错误

### 2.1 修复 ReactDOMTestUtils.act 已弃用警告
- 更新测试库依赖
- 确保使用正确的 act 导入方式

### 2.2 修复 aiService 测试中的类型错误
- 确保测试代码符合 TypeScript 类型要求
- 修复私有方法访问问题

## 3. 增加测试覆盖率

### 3.1 扩展 aiService 测试覆盖范围
- API Key 设置和获取功能测试
- 不同 provider 处理逻辑测试
- localStorage 持久化功能测试
- 各种文本处理模式测试（expand, summarize, refine）
- 错误处理和边界情况测试

### 3.2 增加其他组件测试
- 为其他主要组件添加测试文件
- 确保组件测试覆盖核心功能和交互

## 4. 优化测试结构和性能

### 4.1 优化测试组织
- 按功能模块组织测试用例
- 使用更清晰的测试描述
- 确保测试用例的独立性

### 4.2 优化测试性能
- 减少不必要的模拟
- 优化测试设置和清理逻辑
- 确保测试用例的执行顺序不影响结果

## 5. 实施步骤

1. **修复 Jest 配置**：更新 jest.config.ts 中的 ts-jest 配置
2. **修复 aiService 环境变量访问**：修改 aiService.ts 以兼容 Jest 环境
3. **修复测试代码错误**：更新测试代码以解决已弃用 API 和类型错误
4. **扩展 aiService 测试**：添加更多测试用例覆盖未测试功能
5. **优化测试结构**：重构测试代码以提高可读性和维护性
6. **运行测试验证**：确保所有测试通过
7. **生成测试覆盖率报告**：分析覆盖率并进一步优化

## 6. 预期结果

- 所有测试通过，无编译错误和警告
- 测试覆盖率提高到 80% 以上
- 测试代码结构清晰，易于维护
- 测试执行性能良好

## 7. 技术栈和工具

- Jest：测试框架
- React Testing Library：组件测试
- TypeScript：类型检查
- ts-jest：TypeScript 测试转换

这个计划将确保项目的测试质量得到显著提升，同时修复现有测试中的问题。